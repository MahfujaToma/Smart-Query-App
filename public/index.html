<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Query App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Prism Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" id="prism-theme">
    <style>
        :root {
            --bg-color: #e9ecef;
            --card-bg: #ffffff;
            --text-color: #212529;
            --navbar-bg: #212529;
            --input-bg: #ffffff;
            --input-text: #212529;
        }

        [data-theme='dark'] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --navbar-bg: #000000;
            --input-bg: #2d2d2d;
            --input-text: #ffffff;
        }

        body {
            padding-top: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid rgba(0,0,0,0.125);
        }

        [data-theme='dark'] .card {
            border: 1px solid rgba(255,255,255,0.1);
        }

        .form-control {
            background-color: var(--input-bg);
            color: var(--input-text);
        }

        .form-control:focus {
            background-color: var(--input-bg);
            color: var(--input-text);
        }

        .auth-container { max-width: 400px; margin: 5rem auto; position: relative; z-index: 1; }
        .main-app-container {
            padding-top: 80px; /* Increased padding for larger navbar */
            min-height: 100vh;
            background-color: var(--bg-color);
        }
        
        /* Prism overrides */
        pre[class*="language-"] {
            margin: 0;
            border-radius: 0.375rem;
            max-height: 400px;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            display: block;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* Watermark for Auth Page */
        .auth-page-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            z-index: 0; /* Ensure it's behind content */
        }

        .auth-page-wrapper::before {
            content: "Smart Query App";
            position: absolute;
            top: 20px; /* Position at the top */
            left: 50%;
            transform: translateX(-50%); /* Center horizontally */
            font-size: 3em; /* Adjust font size for a header-like appearance */
            font-weight: 300; /* Lighter weight */
            color: rgba(128, 128, 128, 0.2); /* Faded gray */
            white-space: nowrap;
            letter-spacing: 2px; /* Slightly more spaced out letters */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05); /* Subtle shadow for depth */
        }
        .navbar-brand.h1 { /* Target specifically the h1 inside navbar-brand */
            font-size: 2.5rem !important; /* Make it larger, using !important to override Bootstrap's h1 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql-formatter@15.4.4/dist/sql-formatter.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_URL = "/api";

        // --- Auth Components ---
        function AuthPage({ onLoginSuccess }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                const endpoint = isLogin ? '/login' : '/register';
                try {
                    const response = await fetch(API_URL + endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'An error occurred.');
                    }

                    if (isLogin) {
                        const data = await response.json();
                        onLoginSuccess(data.accessToken);
                    } else {
                        alert('Registration successful! Please log in.');
                        setIsLogin(true);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="auth-page-wrapper">
                    <div className="auth-container card p-4 shadow">
                        <h2 className="text-center mb-4 text-primary">üîç Smart Query App</h2>
                        {error && <div className="alert alert-danger">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-floating mb-3">
                                <input
                                    type="text"
                                    className="form-control"
                                    id="username"
                                    placeholder="Username"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                    autocomplete="off"
                                />
                                <label htmlFor="username">Username</label>
                            </div>
                            <div className="form-floating mb-3">
                                <input
                                    type="password"
                                    className="form-control"
                                    id="password"
                                    placeholder="Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    autocomplete="new-password"
                                />
                                <label htmlFor="password">Password</label>
                            </div>
                            <button type="submit" className="w-100 btn btn-lg btn-primary">{isLogin ? 'Login' : 'Register'}</button>
                        </form>
                        <button onClick={() => setIsLogin(!isLogin)} className="w-100 btn btn-link mt-2">
                            {isLogin ? 'Need an account? Register' : 'Have an account? Login'}
                        </button>
                    </div>
                </div>
            );
        }

        // --- Main App Components ---
        function TitleBar({ onLogout, onShowHistory, theme, onToggleTheme, onExport, onImportClick }) {
            return (
                <nav className={`navbar fixed-top ${theme === 'dark' ? 'navbar-dark bg-dark shadow' : 'navbar-dark bg-dark shadow'}`}>
                    <div className="container-fluid d-flex justify-content-between align-items-center">
                        <span className="navbar-brand mb-0 h1 mx-auto text-info"><i className="bi bi-search"></i> Smart Query App</span>
                        <div className="d-flex align-items-center">
                            <div className="btn-group me-2">
                                <button onClick={onExport} className="btn btn-sm btn-outline-light" title="Export Backup (JSON)">
                                    <i className="bi bi-download"></i>
                                </button>
                                <button onClick={onImportClick} className="btn btn-sm btn-outline-light" title="Import Backup (JSON)">
                                    <i className="bi bi-upload"></i>
                                </button>
                            </div>
                            <button 
                                onClick={onToggleTheme} 
                                className="btn btn-sm btn-outline-warning me-2" 
                                title="Toggle Theme"
                            >
                                <i className={`bi bi-${theme === 'light' ? 'moon-fill' : 'sun-fill'}`}></i>
                            </button>
                            <button onClick={onShowHistory} className="btn btn-outline-info me-2">History</button>
                            <button onClick={onLogout} className="btn btn-outline-light">Logout</button>
                        </div>
                    </div>
                </nav>
            );
        }

        function SearchBar({ onSearch, inputRef }) {
            const [inputTerm, setInputTerm] = useState("");

            const handleSearchClick = () => {
                onSearch(inputTerm);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    onSearch(inputTerm);
                }
            };

            return (
                <div className="input-group mb-3">
                    <input
                        ref={inputRef}
                        type="text"
                        className="form-control"
                        placeholder="Search by title (Ctrl + F to focus)..."
                        value={inputTerm}
                        onChange={(e) => setInputTerm(e.target.value)}
                        onKeyDown={handleKeyDown}
                    />
                    <button className="btn btn-outline-secondary" type="button" onClick={handleSearchClick} title="Search">
                        <i className="bi bi-search"></i>
                    </button>
                </div>
            );
        }
        
        function AddQueryForm({ onAddQuery }) {
            const [title, setTitle] = useState("");
            const [query, setQuery] = useState("");

            const handleFormat = () => {
                try {
                    setQuery(sqlFormatter.format(query));
                } catch (e) {
                    console.error("Format error", e);
                    alert("Could not format SQL. Check for syntax errors.");
                }
            };

            const handleSubmit = (e) => {
                if (e) e.preventDefault();
                if (!title || !query) return;
                onAddQuery({ title, query });
                setTitle("");
                setQuery("");
            };

            const handleKeyDown = (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    handleSubmit();
                }
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    handleFormat();
                }
            };

            return (
                <div className="card shadow-sm mb-4 border-0" onKeyDown={handleKeyDown}>
                    <div className="card-header bg-info text-white d-flex justify-content-between align-items-center rounded-top">
                        <h5 className="card-title mb-0 fw-bold"><i className="bi bi-plus-circle-fill me-2"></i>New Query</h5>
                        <button type="button" onClick={handleFormat} className="btn btn-sm btn-outline-light rounded-pill px-3">
                            <i className="bi bi-magic me-1"></i> Format (Ctrl+Enter)
                        </button>
                    </div>
                    <div className="card-body bg-white rounded-bottom">
                        <form onSubmit={handleSubmit}>
                            <div className="mb-3">
                                <label className="form-label small fw-bold text-info">Title</label>
                                <input
                                    type="text"
                                    className="form-control bg-light border-0 shadow-none"
                                    placeholder="e.g., Get All Recent Users"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                />
                            </div>
                            <div className="mb-3">
                                <label className="form-label small fw-bold text-info">SQL Code</label>
                                <textarea
                                    className="form-control bg-light border-0 font-monospace shadow-none"
                                    rows="4"
                                    placeholder="SELECT * FROM users..."
                                    value={query}
                                    onChange={(e) => setQuery(e.target.value)}
                                ></textarea>
                            </div>
                            <button type="submit" className="btn btn-primary w-100 fw-bold py-2 shadow-sm rounded-pill">
                                <i className="bi bi-save2 me-2"></i> Save Query (Ctrl+S)
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function QueryItem({ query, onDeleteQuery, onUpdateQuery, getAuthHeader }) {
            const [isTitleEditing, setIsTitleEditing] = useState(false);
            const [isQueryEditing, setIsQueryEditing] = useState(false);
            const [editedTitle, setEditedTitle] = useState(query.title);
            const [editedQuery, setEditedQuery] = useState(query.query_text || query.query || "");
            const textAreaRef = useRef(null);
            const codeRef = useRef(null);

            const isDirty = (editedQuery !== (query.query_text || query.query)) || editedTitle !== query.title;

            useEffect(() => {
                setEditedTitle(query.title);
                setEditedQuery(query.query_text || query.query || "");
            }, [query]);

            useEffect(() => {
                if (!isQueryEditing && codeRef.current) {
                    Prism.highlightElement(codeRef.current);
                }
            }, [isQueryEditing, editedQuery]);

            const handleCopyQuery = () => {
                navigator.clipboard.writeText(editedQuery).then(() => {
                    alert('Query copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            };

            const handleFormat = () => {
                try {
                    setEditedQuery(sqlFormatter.format(editedQuery));
                } catch (e) {
                    console.error("Format error", e);
                }
            };

            const handleShare = async () => {
                try {
                    const response = await fetch(`${API_URL}/queries/share/${query.id}`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) throw new Error('Failed to create share link.');
                    const data = await response.json();
                    navigator.clipboard.writeText(data.shareLink).then(() => {
                        alert('Share link copied to clipboard!');
                    });
                } catch (error) {
                    console.error('Error sharing query:', error);
                    alert('Failed to share query.');
                }
            };

            const handleDeleteClick = () => {
                if (window.confirm('Are you sure you want to delete this query?')) {
                    onDeleteQuery(query.id);
                }
            };

            const handleToggleTitleEdit = () => {
                setIsTitleEditing(!isTitleEditing);
            };

            const handleKeyDown = (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (isDirty) handleSave();
                }
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    handleFormat();
                }
            };

            return (
                <div className="card border-info shadow-sm mb-3" onKeyDown={handleKeyDown}>
                    <div className="card-body">
                        <div className="d-flex justify-content-between align-items-start">
                             <div className="flex-grow-1">
                                {isTitleEditing ? (
                                    <input
                                        type="text"
                                        className="form-control mb-2"
                                        value={editedTitle}
                                        onChange={(e) => setEditedTitle(e.target.value)}
                                        onBlur={() => setIsTitleEditing(false)}
                                        autoFocus
                                    />
                                ) : (
                                    <h5 className="card-title text-info mb-0" onClick={() => setIsTitleEditing(true)} style={{cursor:'pointer'}}>
                                        {query.title} <i className="bi bi-pencil ms-2" style={{fontSize:'0.8rem', opacity:0.5}}></i>
                                    </h5>
                                )}
                                <small className="text-muted" style={{ fontSize: '0.75em' }}>
                                    Updated: {new Date(query.updated_at || query.updatedAt).toLocaleString()}
                                </small>
                             </div>
                            <div className="text-end">
                                <div className="btn-group">
                                    <button onClick={() => setIsQueryEditing(!isQueryEditing)} className={`btn btn-sm ${isQueryEditing ? 'btn-info' : 'btn-outline-info'}`} title="Edit SQL">
                                        <i className="bi bi-code-slash"></i>
                                    </button>
                                    <button onClick={handleFormat} className="btn btn-sm btn-outline-secondary" title="Format SQL">
                                        <i className="bi bi-magic"></i>
                                    </button>
                                    <button onClick={handleCopyQuery} className="btn btn-sm btn-outline-primary" title="Copy Query"><i className="bi bi-clipboard"></i></button>
                                    <button onClick={handleShare} className="btn btn-sm btn-outline-success" title="Share Query"><i className="bi bi-share"></i></button>
                                    <button onClick={handleDeleteClick} className="btn btn-sm btn-outline-danger" title="Delete Query"><i className="bi bi-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-3">
                            {isQueryEditing ? (
                                <textarea
                                    ref={textAreaRef}
                                    className="form-control font-monospace"
                                    rows="8"
                                    value={editedQuery}
                                    onChange={(e) => setEditedQuery(e.target.value)}
                                    autoFocus
                                ></textarea>
                            ) : (
                                <div className="position-relative">
                                    <pre className="language-sql"><code ref={codeRef} className="language-sql">{editedQuery}</code></pre>
                                    <button 
                                        onClick={() => setIsQueryEditing(true)} 
                                        className="btn btn-sm btn-light position-absolute top-0 end-0 m-2 opacity-50 hover-opacity-100"
                                        title="Quick Edit"
                                    >
                                        <i className="bi bi-pencil"></i>
                                    </button>
                                </div>
                            )}
                        </div>

                        {isDirty && (
                             <button onClick={handleSave} className="btn btn-success btn-sm mt-3 w-100 fw-bold">
                                 <i className="bi bi-check-lg me-1"></i> Save All Changes
                             </button>
                        )}
                    </div>
                </div>
            );
        }

        function QueryList({ queries, onDeleteQuery, onUpdateQuery, getAuthHeader }) {
            if (queries.length === 0) {
                return (
                    <div className="empty-state card shadow-sm p-5 border-0 rounded-4">
                        <i className="bi bi-database-add text-info opacity-25 mb-4" style={{fontSize: '6rem'}}></i>
                        <h3 className="fw-bold text-info">Your library is empty</h3>
                        <p className="text-muted mb-4 lead">Ready to store your first query snippet?</p>
                        <div className="d-inline-block p-3 bg-info bg-opacity-10 rounded-pill px-4 text-info fw-bold animate-bounce">
                           <i className="bi bi-arrow-up-circle-fill me-2"></i> Use the form above to get started
                        </div>
                    </div>
                );
            }

            return (
                <div className="mt-4">
                    <h5 className="mb-4 text-secondary d-flex align-items-center fw-bold">
                        <i className="bi bi-collection-fill me-2 text-info"></i> SAVED QUERIES
                        <span className="badge bg-info text-white ms-3 rounded-pill" style={{fontSize: '0.8rem'}}>{queries.length}</span>
                    </h5>
                    {queries.map(q => (
                        <QueryItem
                            key={q.id}
                            query={q}
                            onDeleteQuery={onDeleteQuery}
                            onUpdateQuery={onUpdateQuery}
                            getAuthHeader={getAuthHeader}
                        />
                    ))}
                </div>
            );
        }

        // --- Query History Component ---
        function QueryHistory({ token, getAuthHeader, onBack }) {
            const [history, setHistory] = useState([]);
            const [error, setError] = useState("");

            useEffect(() => {
                const fetchHistory = async () => {
                    try {
                        const response = await fetch(`${API_URL}/history`, { headers: getAuthHeader() });
                        if (!response.ok) throw new Error('Could not fetch query history.');
                        const data = await response.json();
                        setHistory(data);
                    } catch (err) {
                        setError(err.message);
                    }
                };
                fetchHistory();
            }, [token]);

            useEffect(() => {
                if (history.length > 0) {
                    Prism.highlightAll();
                }
            }, [history]);

            const handleDeleteHistoryEntry = async (historyId) => {
                if (!window.confirm('Are you sure you want to delete this history entry?')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/history/${historyId}`, {
                        method: 'DELETE',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to delete history entry.');
                    }
                    setHistory(history.filter(entry => entry.id !== historyId));
                } catch (err) {
                    setError(err.message);
                    alert(`Error deleting history entry: ${err.message}`);
                }
            };

            const handleDeleteAllHistory = async () => {
                if (!window.confirm('Are you sure you want to delete your entire query history? This action cannot be undone.')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/history/all`, {
                        method: 'DELETE',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to delete all history entries.');
                    }
                    setHistory([]);
                } catch (err) {
                    setError(err.message);
                    alert(`Error clearing history: ${err.message}`);
                }
            };

            return (
                <div>
                    <button onClick={onBack} className="btn btn-secondary mb-4 shadow-sm rounded-pill px-4"><i className="bi bi-arrow-left-circle me-2"></i> Back to My Queries</button>
                    <div className="d-flex justify-content-between align-items-center mb-4">
                        <h4 className="mb-0 text-secondary fw-bold"><i className="bi bi-clock-history me-2 text-info"></i> Query History</h4>
                        {history.length > 0 && (
                            <button
                                onClick={handleDeleteAllHistory}
                                className="btn btn-outline-danger btn-sm rounded-pill px-3"
                                title="Delete All History"
                            >
                                <i className="bi bi-trash-fill"></i> Clear All
                            </button>
                        )}
                    </div>
                    {error && <div className="alert alert-danger shadow-sm border-0">{error}</div>}
                    {history.length === 0 ? (
                        <div className="text-center py-5">
                            <i className="bi bi-clock-history text-light mb-3" style={{fontSize: '4rem'}}></i>
                            <p className="text-muted">No activity recorded yet.</p>
                        </div>
                    ) : (
                        <div className="history-timeline">
                            {history.map(entry => (
                                <div key={entry.id} className="card mb-4 shadow-sm border-0 rounded-3">
                                    <div className="card-header bg-light d-flex justify-content-between align-items-center border-0 py-3">
                                        <h6 className="mb-0 fw-bold text-info">{entry.title || 'Untitled Query'}</h6>
                                        <small className="text-muted"><i className="bi bi-calendar3 me-1"></i> {new Date(entry.createdAt).toLocaleString()}</small>
                                    </div>
                                    <div className="card-body">
                                        <pre className="language-sql"><code className="language-sql">{entry.query}</code></pre>
                                        <div className="text-end mt-3">
                                            <button
                                                onClick={() => handleDeleteHistoryEntry(entry.id)}
                                                className="btn btn-sm btn-link text-danger p-0 text-decoration-none"
                                                title="Delete History Entry"
                                            >
                                                <i className="bi bi-trash"></i> Remove from history
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        function MainApp({ token, onLogout, theme, onToggleTheme }) {
            const [queries, setQueries] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [error, setError] = useState("");
            const [showHistory, setShowHistory] = useState(false); // State to toggle between main queries and history
            const searchInputRef = useRef(null);
            const importInputRef = useRef(null);

            const getAuthHeader = () => ({
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            });

            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ctrl + F: Focus search
                    if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        if (searchInputRef.current) searchInputRef.current.focus();
                    }
                    // Ctrl + I: Trigger Import
                    if (e.ctrlKey && e.key === 'i') {
                        e.preventDefault();
                        if (importInputRef.current) importInputRef.current.click();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            const handleExport = () => {
                if (queries.length === 0) {
                    alert("Nothing to export!");
                    return;
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(queries, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `smart_queries_backup_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedQueries = JSON.parse(event.target.result);
                        if (!Array.isArray(importedQueries)) throw new Error("Invalid file format.");

                        if (confirm(`Do you want to import ${importedQueries.length} queries?`)) {
                            for (const q of importedQueries) {
                                await handleAddQuery({ title: q.title, query: q.query_text || q.query });
                            }
                            alert("Import successful!");
                        }
                    } catch (err) {
                        alert("Error importing: " + err.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            };
            // ... (rest of the component stays the same)
            useEffect(() => {
                // Fetch queries only if not showing history
                if (!showHistory) {
                    const fetchQueries = async () => {
                        try {
                            const response = await fetch(`${API_URL}/queries`, { headers: getAuthHeader() });
                            if (!response.ok) throw new Error('Could not fetch queries.');
                            const data = await response.json();
                            setQueries(data);
                        } catch (err) {
                            setError(err.message);
                        }
                    };
                    fetchQueries();
                } else {
                    setQueries([]); // Clear queries if history is shown to avoid displaying both
                }
            }, [token, showHistory]); // Re-fetch when token or showHistory changes
            
            const addQueryToHistoryAPI = async (queryData) => {
                try {
                    const response = await fetch(`${API_URL}/history`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify({ title: queryData.title, query: queryData.query_text || queryData.query }),
                    });
                    if (!response.ok) {
                        console.error('Failed to add search result to history.');
                    }
                } catch (err) {
                    console.error('Error adding to history:', err);
                }
            };

            const handleSearch = (term) => {
                setSearchTerm(term);

                const lowercasedTerm = term.toLowerCase().trim();
                const showAllKeywords = ['all', 'all queries'];

                if (lowercasedTerm && !showAllKeywords.includes(lowercasedTerm)) {
                    const results = queries.filter(q => q.title.toLowerCase() === lowercasedTerm);
                    results.forEach(q => {
                        addQueryToHistoryAPI(q);
                    });
                }
            };

            const handleAddQuery = async (newQuery) => {
                try {
                    const response = await fetch(`${API_URL}/queries`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify(newQuery),
                    });
                    if (!response.ok) throw new Error('Could not add query.');
                    const savedQuery = await response.json();
                    setQueries(prev => [...prev, savedQuery]);
                    return savedQuery;
                } catch (err) {
                    setError(err.message);
                    throw err;
                }
            };

            const handleDeleteQuery = async (id) => {
                 try {
                    const response = await fetch(`${API_URL}/queries/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) throw new Error('Could not delete query.');
                    setQueries(queries.filter(q => q.id !== id));
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleUpdateQuery = async (id, updatedData) => {
                try {
                    const response = await fetch(`${API_URL}/queries/update/${id}`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify(updatedData),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || `Error: ${response.status}`);
                    }
                    
                    const savedQuery = await response.json();
                    
                    alert('Query updated successfully!');
                    
                    setQueries(queries.map(q => q.id === id ? savedQuery : q));
                } catch (err) {
                    setError(err.message);
                    alert(`Failed to update query: ${err.message}`);
                }
            };

            const handleShowHistory = () => {
                setShowHistory(true);
            };

            const handleHideHistory = () => {
                setShowHistory(false);
            };
            
            const lowercasedSearchTerm = searchTerm.toLowerCase().trim();
            const showAllKeywords = ['all', 'all queries'];

            const filteredQueries = showAllKeywords.includes(lowercasedSearchTerm) || !lowercasedSearchTerm
                ? queries
                : queries.filter(q => q.title.toLowerCase() === lowercasedSearchTerm);

            return (
                <div className="main-app-container">
                    <TitleBar 
                        onLogout={onLogout} 
                        onShowHistory={handleShowHistory} 
                        theme={theme} 
                        onToggleTheme={onToggleTheme} 
                        onExport={handleExport}
                        onImportClick={() => importInputRef.current.click()}
                    />
                    <input 
                        type="file" 
                        ref={importInputRef} 
                        style={{ display: 'none' }} 
                        accept=".json" 
                        onChange={handleImport} 
                    />
                    <div className="container">
                        {error && <div className="alert alert-danger">{error}</div>}
                        {showHistory ? (
                            <QueryHistory token={token} getAuthHeader={getAuthHeader} onBack={handleHideHistory} />
                        ) : (
                            <>
                                <AddQueryForm onAddQuery={handleAddQuery} />
                                <hr />
                                <SearchBar onSearch={handleSearch} inputRef={searchInputRef} />
                                <QueryList
                                    queries={filteredQueries}
                                    onDeleteQuery={handleDeleteQuery}
                                    onUpdateQuery={handleUpdateQuery}
                                    getAuthHeader={getAuthHeader}
                                />
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // --- App ---
        function App() {
            const [token, setToken] = useState(localStorage.getItem("authToken"));
            const [theme, setTheme] = useState(localStorage.getItem("theme") || "light");

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem("theme", theme);
            }, [theme]);

            const handleToggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            };

            const handleLoginSuccess = (newToken) => {
                localStorage.setItem("authToken", newToken);
                setToken(newToken);
            };

            const handleLogout = () => {
                localStorage.removeItem("authToken");
                setToken(null);
            };

            if (!token) {
                return <AuthPage onLoginSuccess={handleLoginSuccess} />;
            }

            return <MainApp token={token} onLogout={handleLogout} theme={theme} onToggleTheme={handleToggleTheme} />;
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>