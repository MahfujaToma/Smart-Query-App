<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Query App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            padding-top: 0;
            background-color: #e9ecef; /* A slightly darker off-white */
        }
        .auth-container { max-width: 400px; margin: 5rem auto; position: relative; z-index: 1; }
        .main-app-container {
            padding-top: 80px; /* Increased padding for larger navbar */
            min-height: 100vh;
            background-color: #f8f9fa; /* Lighter background for the app content */
        }

        /* Watermark for Auth Page */
        .auth-page-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            z-index: 0; /* Ensure it's behind content */
        }

        .auth-page-wrapper::before {
            content: "Smart Query App";
            position: absolute;
            top: 20px; /* Position at the top */
            left: 50%;
            transform: translateX(-50%); /* Center horizontally */
            font-size: 3em; /* Adjust font size for a header-like appearance */
            font-weight: 300; /* Lighter weight */
            color: rgba(128, 128, 128, 0.2); /* Faded gray */
            white-space: nowrap;
            letter-spacing: 2px; /* Slightly more spaced out letters */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05); /* Subtle shadow for depth */
        }
        .navbar-brand.h1 { /* Target specifically the h1 inside navbar-brand */
            font-size: 2.5rem !important; /* Make it larger, using !important to override Bootstrap's h1 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_URL = "/api";

        // --- Auth Components ---
        function AuthPage({ onLoginSuccess }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                const endpoint = isLogin ? '/login' : '/register';
                try {
                    const response = await fetch(API_URL + endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'An error occurred.');
                    }

                    if (isLogin) {
                        const data = await response.json();
                        onLoginSuccess(data.accessToken);
                    } else {
                        alert('Registration successful! Please log in.');
                        setIsLogin(true);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="auth-page-wrapper">
                    <div className="auth-container card p-4 shadow">
                        <h2 className="text-center mb-4 text-primary">üîç Smart Query App</h2>
                        {error && <div className="alert alert-danger">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-floating mb-3">
                                <input
                                    type="text"
                                    className="form-control"
                                    id="username"
                                    placeholder="Username"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                    autocomplete="off"
                                />
                                <label htmlFor="username">Username</label>
                            </div>
                            <div className="form-floating mb-3">
                                <input
                                    type="password"
                                    className="form-control"
                                    id="password"
                                    placeholder="Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    autocomplete="new-password"
                                />
                                <label htmlFor="password">Password</label>
                            </div>
                            <button type="submit" className="w-100 btn btn-lg btn-primary">{isLogin ? 'Login' : 'Register'}</button>
                        </form>
                        <button onClick={() => setIsLogin(!isLogin)} className="w-100 btn btn-link mt-2">
                            {isLogin ? 'Need an account? Register' : 'Have an account? Login'}
                        </button>
                    </div>
                </div>
            );
        }

        // --- Main App Components ---
        function TitleBar({ onLogout, onShowHistory }) {
            return (
                <nav className="navbar navbar-dark bg-dark fixed-top">
                    <div className="container-fluid d-flex justify-content-between align-items-center">
                        <span className="navbar-brand mb-0 h1 mx-auto text-info"><i className="bi bi-search"></i> Smart Query App</span>
                        <div> {/* Grouping buttons on the right */}
                            <button onClick={onShowHistory} className="btn btn-outline-info">History</button>
                            <button onClick={onLogout} className="btn btn-outline-light ms-2">Logout</button> {/* ms-2 for margin-left */}
                        </div>
                    </div>
                </nav>
            );
        }

        function SearchBar({ onSearch }) {
            const [inputTerm, setInputTerm] = useState("");

            const handleSearchClick = () => {
                onSearch(inputTerm);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    onSearch(inputTerm);
                }
            };

            return (
                <div className="input-group mb-3">
                    <input
                        type="text"
                        className="form-control"
                        placeholder="Search by title..."
                        value={inputTerm}
                        onChange={(e) => setInputTerm(e.target.value)}
                        onKeyDown={handleKeyDown}
                    />
                    <button className="btn btn-outline-secondary" type="button" onClick={handleSearchClick} title="Search">
                        <i className="bi bi-search"></i>
                    </button>
                </div>
            );
        }
        
        function AddQueryForm({ onAddQuery }) {
            const [title, setTitle] = useState("");
            const [query, setQuery] = useState("");

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!title || !query) return;
                onAddQuery({ title, query });
                setTitle("");
                setQuery("");
            };

            return (
                <div className="card shadow-sm mb-4">
                    <div className="card-header bg-info text-white">
                        <h5 className="card-title mb-0">‚ú® Add New Query</h5>
                    </div>
                    <div className="card-body">
                        <form onSubmit={handleSubmit}>
                            <div className="mb-3">
                                <input
                                    type="text"
                                    className="form-control"
                                    placeholder="Title"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                />
                            </div>
                            <div className="mb-3">
                                <textarea
                                    className="form-control"
                                    rows="3"
                                    placeholder="Query"
                                    value={query}
                                    onChange={(e) => setQuery(e.target.value)}
                                ></textarea>
                            </div>
                            <button type="submit" className="btn btn-primary w-100 fw-bold">Save Query</button>
                        </form>
                    </div>
                </div>
            );
        }

        function QueryItem({ query, onDeleteQuery, onUpdateQuery, getAuthHeader }) {
            const [isTitleEditing, setIsTitleEditing] = useState(false);
            const [editedTitle, setEditedTitle] = useState(query.title);
            const [editedQuery, setEditedQuery] = useState(query.query);
            const textAreaRef = useRef(null);

            const isDirty = editedQuery !== query.query || editedTitle !== query.title;

            useEffect(() => {
                setEditedTitle(query.title);
                setEditedQuery(query.query);
            }, [query]);

            const handleCopyQuery = () => {
                navigator.clipboard.writeText(editedQuery).then(() => {
                    alert('Query copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy query.');
                });
            };

            const handleShare = async () => {
                try {
                    const response = await fetch(`${API_URL}/queries/share/${query.id}`, {
                        method: 'POST',
                        headers: getAuthHeader(), // Assuming getAuthHeader is available in this scope
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create share link.');
                    }

                    const data = await response.json();
                    navigator.clipboard.writeText(data.shareLink).then(() => {
                        alert('Share link copied to clipboard!');
                    }).catch(err => {
                        console.error('Failed to copy share link: ', err);
                        alert('Could not copy share link, but here it is: ' + data.shareLink);
                    });
                } catch (error) {
                    console.error('Error sharing query:', error);
                    alert('Failed to share query.');
                }
            };

            const handleDeleteClick = () => {
                const textarea = textAreaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;

                if (start !== end) {
                    const newValue = editedQuery.substring(0, start) + editedQuery.substring(end);
                    setEditedQuery(newValue);
                } else {
                    if (window.confirm('Are you sure you want to delete this entire query?')) {
                        onDeleteQuery(query.id);
                    }
                }
            };

            const handleToggleTitleEdit = () => {
                if (isTitleEditing && editedTitle !== query.title) {
                     if (window.confirm('You have unsaved changes to the title. Do you want to save them?')) {
                        handleSave();
                     } else {
                        setEditedTitle(query.title); // Revert changes
                     }
                }
                setIsTitleEditing(!isTitleEditing);
            };

            const handleSave = () => {
                onUpdateQuery(query.id, { title: editedTitle, query: editedQuery });
                setIsTitleEditing(false);
            };

            return (
                <div className="card border-info shadow-sm mb-3">
                    <div className="card-body">
                        <div className="d-flex justify-content-between align-items-start">
                             {isTitleEditing ? (
                                <input
                                    type="text"
                                    className="form-control mb-2"
                                    value={editedTitle}
                                    onChange={(e) => setEditedTitle(e.target.value)}
                                    onBlur={handleToggleTitleEdit}
                                    autoFocus
                                />
                            ) : (
                                <h5 className="card-title text-info mb-0">{query.title}</h5>
                            )}
                            <div className="text-end">
                                <small className="text-muted" style={{ fontSize: '0.75em' }}>
                                    Updated: {new Date(query.updatedAt).toLocaleString()}
                                </small>
                                <div className="btn-group mt-1">
                                    <button onClick={handleToggleTitleEdit} className="btn btn-sm btn-outline-secondary" title="Edit Title">
                                        <i className={`bi ${isTitleEditing ? 'bi-x-lg' : 'bi-pencil-square'}`}></i>
                                    </button>
                                    <button onClick={handleCopyQuery} className="btn btn-sm btn-outline-info" title="Copy Query"><i className="bi bi-clipboard"></i></button>
                                    <button onClick={handleShare} className="btn btn-sm btn-outline-success" title="Share Query"><i className="bi bi-share"></i></button>
                                    <button onClick={handleDeleteClick} className="btn btn-sm btn-outline-danger" title="Delete Query"><i className="bi bi-trash"></i></button>
                                </div>
                            </div>
                        </div>
                         <textarea
                            ref={textAreaRef}
                            className="form-control mt-2"
                            rows="5"
                            value={editedQuery}
                            onChange={(e) => setEditedQuery(e.target.value)}
                        ></textarea>
                        {isDirty && (
                             <button onClick={handleSave} className="btn btn-success btn-sm mt-2">Save Changes</button>
                        )}
                    </div>
                </div>
            );
        }

        function QueryList({ queries, onDeleteQuery, onUpdateQuery, getAuthHeader }) {
            if (queries.length === 0) {
                return <p className="text-center">No queries found. Add one to get started!</p>;
            }

            return (
                <div>
                    <h4 className="mb-3 text-secondary">Your Saved Queries</h4>
                    {queries.map(q => (
                        <QueryItem
                            key={q.id}
                            query={q}
                            onDeleteQuery={onDeleteQuery}
                            onUpdateQuery={onUpdateQuery}
                            getAuthHeader={getAuthHeader}
                        />
                    ))}
                </div>
            );
        }

        // --- Query History Component ---
        function QueryHistory({ token, getAuthHeader, onBack }) {
            const [history, setHistory] = useState([]);
            const [error, setError] = useState("");

            useEffect(() => {
                const fetchHistory = async () => {
                    try {
                        const response = await fetch(`${API_URL}/history`, { headers: getAuthHeader() });
                        if (!response.ok) throw new Error('Could not fetch query history.');
                        const data = await response.json();
                        setHistory(data);
                    } catch (err) {
                        setError(err.message);
                    }
                };
                fetchHistory();
            }, [token]);

            const handleDeleteHistoryEntry = async (historyId) => {
                if (!window.confirm('Are you sure you want to delete this history entry?')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/history/${historyId}`, {
                        method: 'DELETE',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to delete history entry.');
                    }
                    setHistory(history.filter(entry => entry.id !== historyId));
                } catch (err) {
                    setError(err.message);
                    alert(`Error deleting history entry: ${err.message}`);
                }
            };

            const handleDeleteAllHistory = async () => {
                if (!window.confirm('Are you sure you want to delete your entire query history? This action cannot be undone.')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/history/all`, {
                        method: 'DELETE',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to delete all history entries.');
                    }
                    setHistory([]);
                } catch (err) {
                    setError(err.message);
                    alert(`Error clearing history: ${err.message}`);
                }
            };

            return (
                <div>
                    <button onClick={onBack} className="btn btn-secondary mb-3"><i className="bi bi-arrow-left"></i> Back to My Queries</button>
                    <div className="d-flex justify-content-between align-items-center mb-3">
                        <h4 className="mb-0 text-secondary">Query History</h4>
                        {history.length > 0 && (
                            <button
                                onClick={handleDeleteAllHistory}
                                className="btn btn-danger"
                                title="Delete All History"
                            >
                                <i className="bi bi-trash"></i> Delete All
                            </button>
                        )}
                    </div>
                    {error && <div className="alert alert-danger">{error}</div>}
                    {history.length === 0 ? (
                        <p className="text-center">No query history found.</p>
                    ) : (
                        <div className="list-group">
                            {history.map(entry => (
                                <div key={entry.id} className="list-group-item list-group-item-action flex-column align-items-start mb-2">
                                    <div className="d-flex w-100 justify-content-between">
                                        <h5 className="mb-1 text-info">{entry.title || 'Untitled Query'}</h5>
                                        <small>{new Date(entry.createdAt).toLocaleString()}</small>
                                    </div>
                                    <p className="mb-1 query-history-text">{entry.query}</p>
                                    <button
                                        onClick={() => handleDeleteHistoryEntry(entry.id)}
                                        className="btn btn-sm btn-outline-danger mt-2"
                                        title="Delete History Entry"
                                    >
                                        <i className="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        function MainApp({ token, onLogout }) {
            const [queries, setQueries] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [error, setError] = useState("");
            const [showHistory, setShowHistory] = useState(false); // State to toggle between main queries and history

            const getAuthHeader = () => ({
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            });

            useEffect(() => {
                // Fetch queries only if not showing history
                if (!showHistory) {
                    const fetchQueries = async () => {
                        try {
                            const response = await fetch(`${API_URL}/queries`, { headers: getAuthHeader() });
                            if (!response.ok) throw new Error('Could not fetch queries.');
                            const data = await response.json();
                            setQueries(data);
                        } catch (err) {
                            setError(err.message);
                        }
                    };
                    fetchQueries();
                } else {
                    setQueries([]); // Clear queries if history is shown to avoid displaying both
                }
            }, [token, showHistory]); // Re-fetch when token or showHistory changes

            const addQueryToHistoryAPI = async (queryData) => {
                try {
                    const response = await fetch(`${API_URL}/history`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify({ title: queryData.title, query: queryData.query }),
                    });
                    if (!response.ok) {
                        console.error('Failed to add search result to history.');
                    }
                } catch (err) {
                    console.error('Error adding to history:', err);
                }
            };

            const handleSearch = (term) => {
                setSearchTerm(term);

                const lowercasedTerm = term.toLowerCase().trim();
                const showAllKeywords = ['all', 'all queries'];

                if (lowercasedTerm && !showAllKeywords.includes(lowercasedTerm)) {
                    const results = queries.filter(q => q.title.toLowerCase() === lowercasedTerm);
                    results.forEach(q => {
                        addQueryToHistoryAPI(q);
                    });
                }
            };

            const handleAddQuery = async (newQuery) => {
                try {
                    const response = await fetch(`${API_URL}/queries`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify(newQuery),
                    });
                    if (!response.ok) throw new Error('Could not add query.');
                    const savedQuery = await response.json();
                    setQueries([...queries, savedQuery]);
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleDeleteQuery = async (id) => {
                 try {
                    const response = await fetch(`${API_URL}/queries/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeader(),
                    });
                    if (!response.ok) throw new Error('Could not delete query.');
                    setQueries(queries.filter(q => q.id !== id));
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleUpdateQuery = async (id, updatedData) => {
                try {
                    const response = await fetch(`${API_URL}/queries/update/${id}`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify(updatedData),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || `Error: ${response.status}`);
                    }
                    
                    const savedQuery = await response.json();
                    
                    alert('Query updated successfully!');
                    
                    setQueries(queries.map(q => q.id === id ? savedQuery : q));
                } catch (err) {
                    setError(err.message);
                    alert(`Failed to update query: ${err.message}`);
                }
            };

            const handleShowHistory = () => {
                setShowHistory(true);
            };

            const handleHideHistory = () => {
                setShowHistory(false);
            };
            
            const lowercasedSearchTerm = searchTerm.toLowerCase().trim();
            const showAllKeywords = ['all', 'all queries'];

            const filteredQueries = showAllKeywords.includes(lowercasedSearchTerm) || !lowercasedSearchTerm
                ? queries
                : queries.filter(q => q.title.toLowerCase() === lowercasedSearchTerm);

            return (
                <div className="main-app-container">
                    <TitleBar onLogout={onLogout} onShowHistory={handleShowHistory} />
                    <div className="container">
                        {error && <div className="alert alert-danger">{error}</div>}
                        {showHistory ? (
                            <QueryHistory token={token} getAuthHeader={getAuthHeader} onBack={handleHideHistory} />
                        ) : (
                            <>
                                <AddQueryForm onAddQuery={handleAddQuery} />
                                <hr />
                                <SearchBar onSearch={handleSearch} />
                                <QueryList
                                    queries={filteredQueries}
                                    onDeleteQuery={handleDeleteQuery}
                                    onUpdateQuery={handleUpdateQuery}
                                    getAuthHeader={getAuthHeader}
                                />
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // --- App ---
        function App() {
            const [token, setToken] = useState(localStorage.getItem("authToken"));

            const handleLoginSuccess = (newToken) => {
                localStorage.setItem("authToken", newToken);
                setToken(newToken);
            };

            const handleLogout = () => {
                localStorage.removeItem("authToken");
                setToken(null);
            };

            if (!token) {
                return <AuthPage onLoginSuccess={handleLoginSuccess} />;
            }

            return <MainApp token={token} onLogout={handleLogout} />;
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>